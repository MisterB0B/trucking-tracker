<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Unified Cloud Sync -->
    <script src="https://thelightparkops.com/shared/cloud-sync.js"></script>
    <title>Trucking Tracker | The Light Park</title>
  <!-- TLP Cloud Sync -->
  <!-- Supabase Cloud Sync ‚Äî proper tables (trucking_items, trucking_loads) -->
  <script>
    const SUPABASE_URL = 'https://gwjtfcrgpxclixonogpe.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3anRmY3JncHhjbGl4b25vZ3BlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzQzOTUsImV4cCI6MjA4NTkxMDM5NX0.qM1-_VA1Dsx_nsWkeoAJvNWNgSuuwApPBGoJU32X3-I';

    const _supa = (path, opts = {}) => fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
      ...opts,
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': opts.prefer || 'return=representation',
        ...opts.headers
      }
    });

    // trucking_items: id, load_id, item_name, quantity, category, scanned, scanned_at, notes, created_at
    // We map: item_name‚Üíname, quantity‚Üíqty, category‚Üívenue, notes‚ÜíJSON{desc,stage,truck,barcode,laneCode}
    // trucking_loads: id, load_name, origin, destination, status, truck, driver, scheduled_date, notes, created_by, created_at, updated_at
    // We map: load_name‚Üítruck id, truck‚Üítype, status‚Üístatus, origin‚Üílocation, driver‚Üídriver

    const TruckingDB = {
      online: navigator.onLine,
      _pending: [],

      itemToRow(item) {
        return {
          item_name: item.name || 'Unknown',
          quantity: item.qty || 1,
          category: item.venue || null,
          notes: JSON.stringify({ desc: item.desc, stage: item.stage, truck: item.truck, barcode: item.barcode, laneCode: item.laneCode, appId: item.id })
        };
      },

      rowToItem(r) {
        let extra = {};
        try { extra = JSON.parse(r.notes || '{}'); } catch(e) {}
        return {
          _supaId: r.id,
          id: extra.appId || Date.now(),
          name: r.item_name || '',
          qty: r.quantity || 1,
          desc: extra.desc || '',
          stage: extra.stage || 'Staged',
          truck: extra.truck || '',
          venue: r.category || '',
          barcode: extra.barcode || '',
          laneCode: extra.laneCode || ''
        };
      },

      fleetToRow(truck) {
        return {
          load_name: truck.id || 'UNKNOWN',
          truck: truck.type || null,
          status: truck.status === 'transit' ? 'in_transit' : truck.status === 'site' ? 'delivered' : 'pending',
          origin: truck.location || null,
          driver: truck.driver || null,
          notes: JSON.stringify({ items: truck.items })
        };
      },

      rowToFleet(r) {
        let extra = {};
        try { extra = JSON.parse(r.notes || '{}'); } catch(e) {}
        return {
          _supaId: r.id,
          id: r.load_name || '',
          type: r.truck || 'Dry Van',
          status: r.status === 'in_transit' ? 'transit' : r.status === 'delivered' ? 'site' : 'hq',
          location: r.origin || '',
          driver: r.driver || '',
          items: extra.items || 0
        };
      },

      async loadItems() {
        if (!this.online) return null;
        try {
          const res = await _supa('trucking_items?select=*&order=created_at.asc');
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return (await res.json()).map(r => this.rowToItem(r));
        } catch(e) { console.error('‚òÅÔ∏è Load items failed:', e); return null; }
      },

      async loadFleet() {
        if (!this.online) return null;
        try {
          const res = await _supa('trucking_loads?select=*&order=load_name.asc');
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return (await res.json()).map(r => this.rowToFleet(r));
        } catch(e) { console.error('‚òÅÔ∏è Load fleet failed:', e); return null; }
      },

      async saveAllItems(items) {
        if (!this.online) return { synced: false };
        try {
          await _supa('trucking_items?id=not.is.null', { method: 'DELETE', prefer: 'return=minimal' });
          if (items.length > 0) {
            const rows = items.map(i => this.itemToRow(i));
            const res = await _supa('trucking_items', { method: 'POST', body: JSON.stringify(rows) });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const created = await res.json();
            created.forEach((r, i) => { if (items[i]) items[i]._supaId = r.id; });
          }
          return { synced: true };
        } catch(e) { console.error('‚òÅÔ∏è Save items failed:', e); return { synced: false }; }
      },

      async saveAllFleet(fleet) {
        if (!this.online) return { synced: false };
        try {
          await _supa('trucking_loads?id=not.is.null', { method: 'DELETE', prefer: 'return=minimal' });
          if (fleet.length > 0) {
            const rows = fleet.map(f => this.fleetToRow(f));
            const res = await _supa('trucking_loads', { method: 'POST', body: JSON.stringify(rows) });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
          }
          return { synced: true };
        } catch(e) { console.error('‚òÅÔ∏è Save fleet failed:', e); return { synced: false }; }
      },

      async flushPending() {
        if (!this.online || this._pending.length === 0) return;
        this._pending = [];
      }
    };

    window.addEventListener('online', () => { TruckingDB.online = true; TruckingDB.flushPending(); });
    window.addEventListener('offline', () => { TruckingDB.online = false; });

    // Legacy CloudSync compat
    window.CloudSync = {
      online: TruckingDB.online,
      async save(k, d) { return { synced: true }; },
      async load(k) { return null; }
    };
  </script>
  <!-- QR/Barcode Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    :root {
      --bg: #0B0D14;
      --surface: #12151F;
      --surface2: #1a1e2e;
      --border: #2a2f42;
      --text: #f0f0f5;
      --text-dim: #8888a0;
      --purple: #a855f7;
      --teal: #06d6a0;
      --pink: #ff4fd8;
      --orange: #f97316;
      --green: #22c55e;
      --red: #ef4444;
      --blue: #3b82f6;
      --yellow: #eab308;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }
    
    /* Splash */
    #splash {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s;
    }
    #splash.hidden { opacity: 0; pointer-events: none; }
    #splash img {
      max-width: 85%;
      max-height: 30vh;
      animation: pulse-glow 2s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { filter: drop-shadow(0 8px 32px rgba(168, 85, 247, 0.4)); }
      50% { filter: drop-shadow(0 8px 48px rgba(6, 214, 160, 0.6)); }
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--purple) 0%, var(--blue) 100%);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header h1 { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
    .header-actions { display: flex; gap: 8px; }
    .header-btn {
      padding: 8px 14px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    
    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 16px;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 800;
    }
    .stat-label { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
    .stat-staged { color: var(--yellow); }
    .stat-packed { color: var(--orange); }
    .stat-transit { color: var(--blue); }
    .stat-delivered { color: var(--green); }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      padding: 0 16px;
      background: var(--surface);
      overflow-x: auto;
    }
    .tab {
      padding: 14px 20px;
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
    }
    .tab.active {
      color: var(--purple);
      border-bottom-color: var(--purple);
    }
    
    .tab-content { display: none; padding: 16px; }
    .tab-content.active { display: block; }
    
    /* Kanban Board */
    .kanban {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 16px;
    }
    .kanban-column {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      min-width: 180px;
      min-height: 400px;
    }
    .column-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .column-count {
      background: var(--surface2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      color: var(--text-dim);
    }
    .column-items {
      padding: 8px;
      min-height: 350px;
    }
    
    /* Stage colors */
    .stage-staged .column-header { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
    .stage-packed .column-header { background: rgba(249, 115, 22, 0.15); color: var(--orange); }
    .stage-loaded .column-header { background: rgba(168, 85, 247, 0.15); color: var(--purple); }
    .stage-transit .column-header { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
    .stage-delivered .column-header { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .stage-returned .column-header { background: rgba(6, 214, 160, 0.15); color: var(--teal); }
    
    /* Item Card */
    .item-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      cursor: grab;
      transition: all 0.2s;
    }
    .item-card:hover {
      border-color: var(--purple);
      transform: translateY(-1px);
    }
    .item-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    .item-name { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
    .item-meta { font-size: 11px; color: var(--text-dim); }
    .item-badges { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap; }
    .badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    .badge-truck { background: rgba(255, 79, 216, 0.2); color: var(--pink); }
    .badge-venue { background: rgba(6, 214, 160, 0.2); color: var(--teal); }
    .badge-qty { background: rgba(148, 163, 184, 0.2); color: var(--text-dim); }
    
    /* Fleet Panel */
    .fleet-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .fleet-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .fleet-header {
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .fleet-name { font-weight: 700; font-size: 16px; }
    .fleet-status {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    .status-hq { background: var(--green); color: white; }
    .status-transit { background: var(--blue); color: white; }
    .status-site { background: var(--purple); color: white; }
    .status-offline { background: var(--surface2); color: var(--text-dim); }
    .fleet-body { padding: 14px; }
    .fleet-location { font-size: 13px; color: var(--text-dim); margin-bottom: 8px; }
    .fleet-items { font-size: 12px; }
    .fleet-driver { font-size: 12px; color: var(--teal); margin-top: 8px; }
    
    /* Manifests */
    .manifests-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .manifest-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .manifest-header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--surface2);
      cursor: pointer;
    }
    .manifest-header:hover { background: var(--border); }
    .manifest-truck-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .manifest-truck-icon {
      font-size: 28px;
    }
    .manifest-truck-name {
      font-weight: 700;
      font-size: 16px;
    }
    .manifest-truck-meta {
      font-size: 12px;
      color: var(--text-dim);
    }
    .manifest-summary {
      text-align: right;
    }
    .manifest-count {
      font-size: 24px;
      font-weight: 800;
      color: var(--purple);
    }
    .manifest-count-label {
      font-size: 11px;
      color: var(--text-dim);
    }
    .manifest-body {
      display: none;
      border-top: 1px solid var(--border);
    }
    .manifest-body.open { display: block; }
    .manifest-items {
      padding: 16px;
    }
    .manifest-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--surface2);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .manifest-item:last-child { margin-bottom: 0; }
    .manifest-item-name {
      font-weight: 600;
      font-size: 14px;
    }
    .manifest-item-desc {
      font-size: 12px;
      color: var(--text-dim);
    }
    .manifest-item-qty {
      background: var(--purple);
      color: white;
      padding: 4px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 13px;
    }
    .manifest-item-venue {
      font-size: 11px;
      color: var(--teal);
      margin-left: 8px;
    }
    .manifest-empty {
      padding: 20px;
      text-align: center;
      color: var(--text-dim);
      font-style: italic;
    }
    .manifest-toggle {
      color: var(--text-dim);
      font-size: 20px;
      transition: transform 0.2s;
    }
    .manifest-card.open .manifest-toggle {
      transform: rotate(180deg);
    }
    
    /* Loading Zones */
    .zones-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }
    .zone-card {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
    }
    .zone-card.occupied {
      border-color: var(--green);
      border-style: solid;
    }
    .zone-card.loading {
      border-color: var(--orange);
      border-style: solid;
    }
    .zone-name { font-weight: 700; font-size: 18px; margin-bottom: 4px; }
    .zone-status { font-size: 13px; color: var(--text-dim); }
    .zone-truck { font-size: 14px; color: var(--green); font-weight: 600; margin-top: 8px; }
    .zone-badge {
      position: absolute;
      top: -8px;
      right: 10px;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
    }
    .badge-loading { background: var(--orange); color: #000; }
    .badge-ready { background: var(--green); color: white; }
    
    /* Venues Panel */
    .venues-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }
    .venue-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }
    .venue-name { font-weight: 700; font-size: 15px; margin-bottom: 8px; }
    .venue-stats { display: flex; gap: 12px; flex-wrap: wrap; }
    .venue-stat {
      font-size: 12px;
      padding: 4px 8px;
      background: var(--surface2);
      border-radius: 4px;
    }
    .venue-stat strong { color: var(--purple); }
    
    /* Form */
    .add-form {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    .form-group label {
      display: block;
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
    }
    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-size: 14px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--purple), var(--pink));
      color: white;
    }
    .btn-secondary {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
    }
    
    /* Scanner Button */
    .scan-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--purple), var(--pink));
      border: none;
      color: white;
      font-size: 28px;
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
      z-index: 100;
    }
    .scan-btn:active { transform: scale(0.95); }
    
    /* Scanner Modal */
    .scanner-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
      flex-direction: column;
    }
    .scanner-modal.open { display: flex; }
    .scanner-header {
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .scanner-header h2 { font-size: 18px; }
    .scanner-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
    }
    .scanner-tabs {
      display: flex;
      background: var(--surface);
    }
    .scanner-tab {
      flex: 1;
      padding: 14px;
      text-align: center;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-dim);
      font-weight: 600;
      cursor: pointer;
    }
    .scanner-tab.active {
      color: var(--purple);
      border-bottom-color: var(--purple);
    }
    .scanner-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .scanner-video-container {
      width: 100%;
      max-width: 400px;
      aspect-ratio: 1;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      margin-bottom: 20px;
    }
    .scanner-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .scanner-overlay {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 200px; height: 200px;
      border: 3px solid var(--purple);
      border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
    }
    .scanner-hint {
      color: var(--text-dim);
      font-size: 14px;
      text-align: center;
    }
    .scanner-result {
      width: 100%;
      max-width: 400px;
      background: var(--surface);
      border-radius: 12px;
      padding: 20px;
      display: none;
    }
    .scanner-result.show { display: block; }
    .scanner-result-title {
      font-size: 14px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }
    .scanner-result-code {
      font-size: 20px;
      font-weight: 700;
      color: var(--purple);
      margin-bottom: 16px;
      word-break: break-all;
    }
    .scanner-item-found {
      background: var(--surface2);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 16px;
    }
    .scanner-item-name {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 4px;
    }
    .scanner-item-meta {
      font-size: 13px;
      color: var(--text-dim);
    }
    .scanner-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .scanner-actions select,
    .scanner-actions input {
      width: 100%;
      padding: 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
    }
    
    /* RFID Section */
    .rfid-input-section {
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .rfid-input {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      text-align: center;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      margin-bottom: 16px;
    }
    .rfid-input:focus {
      border-color: var(--purple);
      outline: none;
    }
    .rfid-status {
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .rfid-ready {
      background: rgba(34, 197, 94, 0.15);
      color: var(--green);
      animation: pulse-ready 2s infinite;
    }
    @keyframes pulse-ready {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
      z-index: 100;
    }
    
    /* Section */
    .section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .kanban { grid-template-columns: repeat(2, 1fr); }
      .kanban-column { min-width: 160px; }
    }
    @media (max-width: 480px) {
      .kanban { grid-template-columns: 1fr; }
    }
  </style>
  <script src="https://thelightparkops.com/shared/supabase-auth.js?v=20260211f"></script>
  <script src="https://thelightparkops.com/shared/activity-logger.js?v=20260211f"></script>
  <script src="https://thelightparkops.com/shared/auth-gate.js?v=20260211f" data-app="Trucking Tracker" data-icon="üöõ"></script>
</head>
<body>
  <!-- Splash -->
  <div id="splash">
    <img src="trucking-logo.jpg" alt="The Light Park Trucking">
  </div>
  
  <!-- Header -->
  <div class="header">
    <a href="/dashboard.html" style="color:#a855f7;text-decoration:none;font-size:13px;font-weight:600;">‚Üê Dashboard</a>
    <h1>üöö Trucking Tracker</h1>
    <div class="header-actions">
      <button class="header-btn" onclick="exportCSV()">üìä Export</button>
      <button class="header-btn" onclick="syncData()">üîÑ Sync</button>
    </div>
  </div>
  
  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-value stat-staged" id="statStaged">0</div>
      <div class="stat-label">Staged</div>
    </div>
    <div class="stat-card">
      <div class="stat-value stat-packed" id="statPacked">0</div>
      <div class="stat-label">Packed</div>
    </div>
    <div class="stat-card">
      <div class="stat-value stat-transit" id="statTransit">0</div>
      <div class="stat-label">In Transit</div>
    </div>
    <div class="stat-card">
      <div class="stat-value stat-delivered" id="statDelivered">0</div>
      <div class="stat-label">Delivered</div>
    </div>
  </div>
  
  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="board">üìã Board</button>
    <button class="tab" data-tab="manifests">üì¶ Manifests</button>
    <button class="tab" data-tab="fleet">üöõ Fleet</button>
    <button class="tab" data-tab="zones">üì° Loading Zones</button>
    <button class="tab" data-tab="venues">üìç Venues</button>
    <button class="tab" data-tab="add">‚ûï Add Item</button>
  </div>
  
  <!-- BOARD TAB -->
  <div class="tab-content active" id="tab-board">
    <div class="kanban" id="kanbanBoard">
      <!-- Generated by JS -->
    </div>
  </div>
  
  <!-- MANIFESTS TAB -->
  <div class="tab-content" id="tab-manifests">
    <div class="section">
      <div class="section-title">üì¶ What's On Each Truck</div>
      <p style="color: var(--text-dim); font-size: 13px; margin-bottom: 16px;">
        Quick view of cargo on each truck. Tap a truck to expand full manifest.
      </p>
      <div class="manifests-grid" id="manifestsGrid">
        <!-- Generated by JS -->
      </div>
    </div>
  </div>
  
  <!-- FLEET TAB -->
  <div class="tab-content" id="tab-fleet">
    <div class="section">
      <div class="section-title">üöõ Active Fleet</div>
      <div class="fleet-grid" id="fleetGrid">
        <!-- Generated by JS -->
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">üõ∞Ô∏è GPS Tracking</div>
      <p style="color: var(--text-dim); font-size: 13px; margin-bottom: 12px;">
        AirTags/GPS trackers on each truck. When truck crosses geofence ‚Üí system auto-updates status.
      </p>
      <div class="venues-grid">
        <div class="venue-card">
          <div class="venue-name">üìç College Station HQ</div>
          <div class="venue-stats">
            <div class="venue-stat">Geofence: <strong>500m</strong></div>
            <div class="venue-stat">Trucks: <strong id="hqTrucks">3</strong></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- LOADING ZONES TAB -->
  <div class="tab-content" id="tab-zones">
    <div class="section">
      <div class="section-title">üè≠ Bay Doors</div>
      <div class="zones-grid" id="bayDoors">
        <!-- Generated by JS -->
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">üÖøÔ∏è Yard Positions</div>
      <div class="zones-grid" id="yardPositions">
        <!-- Generated by JS -->
      </div>
    </div>
  </div>
  
  <!-- VENUES TAB -->
  <div class="tab-content" id="tab-venues">
    <div class="section">
      <div class="section-title">üìç Delivery Status by Venue</div>
      <div class="venues-grid" id="venuesGrid">
        <!-- Generated by JS -->
      </div>
    </div>
  </div>
  
  <!-- ADD ITEM TAB -->
  <div class="tab-content" id="tab-add">
    <div class="add-form">
      <div class="form-title">‚ûï Add New Item</div>
      <div class="form-row">
        <div class="form-group">
          <label>Item Name *</label>
          <input type="text" id="itemName" placeholder="Mega Tree #1">
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" id="itemQty" value="1" min="1">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Description</label>
          <input type="text" id="itemDesc" placeholder="Main display piece">
        </div>
        <div class="form-group">
          <label>Barcode/ID</label>
          <input type="text" id="itemBarcode" placeholder="TREE-MEGA-01">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Destination Venue</label>
          <select id="itemVenue">
            <option value="">-- Select --</option>
            <option value="katy">Katy</option>
            <option value="spring">Spring</option>
            <option value="selma">Selma</option>
            <option value="missions">Missions</option>
            <option value="arlington">Arlington</option>
            <option value="frisco">Frisco</option>
            <option value="round-rock">Round Rock</option>
            <option value="okc">Oklahoma City</option>
          </select>
        </div>
        <div class="form-group">
          <label>Lane Code üìç</label>
          <input type="text" id="itemLaneCode" placeholder="3A, 7B, 12C..." style="text-transform: uppercase;">
          <div style="font-size: 11px; color: var(--text-dim); margin-top: 4px;">
            <a href="https://thelightparkops.com/venue-layout-map/" target="_blank" style="color: var(--purple);">View Lane Map ‚Üí</a>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Assign Truck</label>
          <select id="itemTruck">
            <option value="">-- Optional --</option>
            <option value="DRYVAN-01">DRYVAN-01</option>
            <option value="DRYVAN-02">DRYVAN-02</option>
            <option value="FLATBED-01">FLATBED-01</option>
            <option value="FLATBED-02">FLATBED-02</option>
            <option value="CONEX-01">CONEX-01</option>
          </select>
        </div>
        <div class="form-group">
          <!-- Empty for layout balance -->
        </div>
      </div>
      <button class="btn btn-primary" onclick="addItem()">‚ûï Add to Staged</button>
    </div>
    
    <div class="section">
      <div class="section-title">üì∑ Scan to Add</div>
      <p style="color: var(--text-dim); font-size: 13px;">
        Use the floating scan button to scan QR codes or barcodes directly into the system.
      </p>
    </div>
  </div>
  
  <!-- Scan Button -->
  <button class="scan-btn" onclick="openScanner()">üì∑</button>
  
  <!-- Scanner Modal -->
  <div class="scanner-modal" id="scannerModal">
    <div class="scanner-header">
      <h2>üì∑ Scan Item</h2>
      <button class="scanner-close" onclick="closeScanner()">‚úï</button>
    </div>
    <div class="scanner-tabs">
      <button class="scanner-tab active" onclick="switchScannerTab('qr')">üì∑ QR / Barcode</button>
      <button class="scanner-tab" onclick="switchScannerTab('rfid')">üì° RFID</button>
      <button class="scanner-tab" onclick="switchScannerTab('manual')">‚å®Ô∏è Manual</button>
    </div>
    
    <!-- QR Scanner Tab -->
    <div class="scanner-body" id="scanner-qr">
      <!-- QR Reader will be injected here by html5-qrcode -->
      <p class="scanner-hint">Point camera at QR code or barcode</p>
      <div class="scanner-result" id="qrScanResult" style="display:none;">
        <div class="scanner-item-found">
          <div class="scanner-item-name" id="qrItemName"></div>
          <div class="scanner-item-meta" id="qrItemMeta"></div>
        </div>
        <div class="scanner-actions" id="qrActions" style="display:none;">
          <select id="qrActionStage">
            <option value="">Update Stage...</option>
            <option value="Staged">‚Üí Staged</option>
            <option value="Packed">‚Üí Packed</option>
            <option value="Loaded">‚Üí Loaded</option>
            <option value="In Transit">‚Üí In Transit</option>
            <option value="Delivered">‚Üí Delivered</option>
            <option value="Returned">‚Üí Returned</option>
          </select>
          <select id="qrActionTruck">
            <option value="">Assign to Truck...</option>
            <option value="DRYVAN-01">DRYVAN-01</option>
            <option value="DRYVAN-02">DRYVAN-02</option>
            <option value="FLATBED-01">FLATBED-01</option>
            <option value="FLATBED-02">FLATBED-02</option>
            <option value="CONEX-01">CONEX-01</option>
            <option value="">‚Äî No Truck ‚Äî</option>
          </select>
          <button class="btn btn-primary" onclick="applyQrAction()">‚úì Apply Changes</button>
          <button class="btn btn-secondary" onclick="scanAnother()">Scan Another</button>
        </div>
      </div>
    </div>
    
    <!-- RFID Tab -->
    <div class="scanner-body" id="scanner-rfid" style="display:none;">
      <div class="rfid-input-section">
        <div class="rfid-status rfid-ready">üì° RFID Reader Ready ‚Äî Waiting for scan...</div>
        <input type="text" class="rfid-input" id="rfidInput" placeholder="RFID tag will appear here" autofocus>
        <p class="scanner-hint">Scan RFID tag with your reader, or type tag ID manually</p>
        <div class="scanner-result" id="rfidResult">
          <div class="scanner-result-title">RFID Tag:</div>
          <div class="scanner-result-code" id="rfidCode"></div>
          <div class="scanner-item-found" id="rfidItem" style="display:none;">
            <div class="scanner-item-name" id="rfidItemName"></div>
            <div class="scanner-item-meta" id="rfidItemMeta"></div>
          </div>
          <div class="scanner-actions">
            <select id="rfidActionStage">
              <option value="">Update Stage...</option>
              <option value="Staged">‚Üí Staged</option>
              <option value="Packed">‚Üí Packed</option>
              <option value="Loaded">‚Üí Loaded</option>
              <option value="In Transit">‚Üí In Transit</option>
              <option value="Delivered">‚Üí Delivered</option>
              <option value="Returned">‚Üí Returned</option>
            </select>
            <select id="rfidActionTruck">
              <option value="">Assign to Truck...</option>
              <option value="DRYVAN-01">DRYVAN-01</option>
              <option value="DRYVAN-02">DRYVAN-02</option>
              <option value="FLATBED-01">FLATBED-01</option>
              <option value="FLATBED-02">FLATBED-02</option>
              <option value="CONEX-01">CONEX-01</option>
              <option value="">‚Äî No Truck ‚Äî</option>
            </select>
            <button class="btn btn-primary" onclick="applyRfidAction()">‚úì Apply Changes</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Manual Entry Tab -->
    <div class="scanner-body" id="scanner-manual" style="display:none;">
      <div class="rfid-input-section">
        <input type="text" class="rfid-input" id="manualInput" placeholder="Enter barcode or ID...">
        <button class="btn btn-primary" style="width:100%;max-width:400px;" onclick="lookupManual()">üîç Look Up Item</button>
        <div class="scanner-result" id="manualResult" style="margin-top:16px;">
          <div class="scanner-item-found" id="manualItem" style="display:none;">
            <div class="scanner-item-name" id="manualItemName"></div>
            <div class="scanner-item-meta" id="manualItemMeta"></div>
          </div>
          <div class="scanner-actions" id="manualActions" style="display:none;">
            <select id="manualActionStage">
              <option value="">Update Stage...</option>
              <option value="Staged">‚Üí Staged</option>
              <option value="Packed">‚Üí Packed</option>
              <option value="Loaded">‚Üí Loaded</option>
              <option value="In Transit">‚Üí In Transit</option>
              <option value="Delivered">‚Üí Delivered</option>
              <option value="Returned">‚Üí Returned</option>
            </select>
            <select id="manualActionTruck">
              <option value="">Assign to Truck...</option>
              <option value="DRYVAN-01">DRYVAN-01</option>
              <option value="DRYVAN-02">DRYVAN-02</option>
              <option value="FLATBED-01">FLATBED-01</option>
              <option value="FLATBED-02">FLATBED-02</option>
              <option value="CONEX-01">CONEX-01</option>
              <option value="">‚Äî No Truck ‚Äî</option>
            </select>
            <button class="btn btn-primary" onclick="applyManualAction()">‚úì Apply Changes</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Supabase config
    const SUPABASE_URL = 'https://gwjtfcrgpxclixonogpe.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3anRmY3JncHhjbGl4b25vZ3BlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzQzOTUsImV4cCI6MjA4NTkxMDM5NX0.qM1-_VA1Dsx_nsWkeoAJvNWNgSuuwApPBGoJU32X3-I';
    
    const stages = ['Staged', 'Packed', 'Loaded', 'In Transit', 'Delivered', 'Returned'];
    const stageClasses = ['staged', 'packed', 'loaded', 'transit', 'delivered', 'returned'];
    
    const venues = [
      { id: 'katy', name: 'Katy', region: 'Houston' },
      { id: 'spring', name: 'Spring', region: 'Houston' },
      { id: 'selma', name: 'Selma', region: 'San Antonio' },
      { id: 'missions', name: 'Missions', region: 'San Antonio' },
      { id: 'arlington', name: 'Arlington', region: 'DFW' },
      { id: 'frisco', name: 'Frisco', region: 'DFW' },
      { id: 'round-rock', name: 'Round Rock', region: 'Austin' },
      { id: 'okc', name: 'Oklahoma City', region: 'Oklahoma' }
    ];
    
    // Demo data
    let items = JSON.parse(localStorage.getItem('truckingItems') || 'null') || [
      { id: 1, name: 'Mega Tree #1', qty: 1, desc: 'Main display', stage: 'Staged', truck: 'FLATBED-01', venue: 'katy', barcode: 'TREE-MEGA-01' },
      { id: 2, name: 'LED Arch #1', qty: 1, desc: 'Entrance arch', stage: 'Staged', truck: 'FLATBED-01', venue: 'katy', barcode: 'ARCH-LED-01' },
      { id: 3, name: 'Traffic Cones', qty: 50, desc: 'Lane markers', stage: 'Packed', truck: 'DRYVAN-01', venue: 'spring', barcode: 'CONE-001' },
      { id: 4, name: 'Pi Controllers', qty: 25, desc: 'FPP units', stage: 'Packed', truck: 'DRYVAN-01', venue: 'spring', barcode: 'CTRL-PI-001' },
      { id: 5, name: 'Truss 10ft', qty: 40, desc: 'Structure', stage: 'Loaded', truck: 'FLATBED-02', venue: 'selma', barcode: 'TRUSS-10' },
      { id: 6, name: 'Gnome Prop A1', qty: 1, desc: 'Katy show', stage: 'In Transit', truck: 'FLATBED-01', venue: 'katy', barcode: 'GNOME-A1' },
      { id: 7, name: 'Pixel Strings', qty: 200, desc: '100ct strings', stage: 'Delivered', truck: '', venue: 'katy', barcode: 'PIXEL-STR-100' },
      { id: 8, name: 'Sandbags', qty: 100, desc: 'Ballast', stage: 'Delivered', truck: '', venue: 'spring', barcode: 'SANDBAG-50' },
      { id: 9, name: 'Storage Totes', qty: 30, desc: 'Empty totes', stage: 'Returned', truck: '', venue: '', barcode: 'TOTE-001' },
      { id: 10, name: 'Extension Cables', qty: 75, desc: '50ft cables', stage: 'Staged', truck: '', venue: 'arlington', barcode: 'CABLE-50' }
    ];
    
    let fleet = [
      { id: 'DRYVAN-01', type: 'Dry Van', status: 'hq', location: 'College Station HQ', driver: 'Mike R.', items: 2 },
      { id: 'DRYVAN-02', type: 'Dry Van', status: 'transit', location: 'En route to Katy', driver: 'Steve L.', items: 0 },
      { id: 'FLATBED-01', type: 'Flatbed', status: 'transit', location: 'En route to Katy', driver: 'Jake T.', items: 3 },
      { id: 'FLATBED-02', type: 'Flatbed', status: 'site', location: 'Selma (loading)', driver: 'Chris M.', items: 1 },
      { id: 'CONEX-01', type: 'Conex', status: 'hq', location: 'College Station HQ', driver: '', items: 0 }
    ];
    
    let loadingZones = {
      bayDoors: [
        { id: 'BAY-1', name: 'Bay Door 1', truck: 'DRYVAN-01', status: 'loading' },
        { id: 'BAY-2', name: 'Bay Door 2', truck: '', status: 'empty' },
        { id: 'BAY-3', name: 'Bay Door 3', truck: '', status: 'empty' }
      ],
      yard: [
        { id: 'YARD-A', name: 'Yard A', truck: 'FLATBED-02', status: 'occupied' },
        { id: 'YARD-B', name: 'Yard B', truck: 'CONEX-01', status: 'occupied' },
        { id: 'YARD-C', name: 'Yard C', truck: '', status: 'empty' },
        { id: 'YARD-D', name: 'Yard D', truck: '', status: 'empty' }
      ]
    };
    
    // Tab navigation
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });
    
    // Render kanban board
    function renderBoard() {
      const board = document.getElementById('kanbanBoard');
      board.innerHTML = stages.map((stage, i) => {
        const stageItems = items.filter(item => item.stage === stage);
        return `
          <div class="kanban-column stage-${stageClasses[i]}" 
               ondrop="dropItem(event, '${stage}')" 
               ondragover="event.preventDefault()">
            <div class="column-header">
              ${stage}
              <span class="column-count">${stageItems.length}</span>
            </div>
            <div class="column-items">
              ${stageItems.map(item => `
                <div class="item-card" draggable="true" 
                     ondragstart="dragItem(event, ${item.id})"
                     ondragend="dragEnd(event)">
                  <div class="item-name">${item.name}</div>
                  <div class="item-meta">${item.desc || ''}</div>
                  <div class="item-badges">
                    ${item.laneCode ? `<span class="badge" style="background: linear-gradient(135deg, #a855f7, #06d6a0); color: white; font-weight: 700;">üìç ${item.laneCode}</span>` : ''}
                    ${item.qty > 1 ? `<span class="badge badge-qty">√ó${item.qty}</span>` : ''}
                    ${item.truck ? `<span class="badge badge-truck">${item.truck}</span>` : ''}
                    ${item.venue ? `<span class="badge badge-venue">${item.venue}</span>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
      
      updateStats();
    }
    
    // Drag and drop
    let draggedId = null;
    
    function dragItem(e, id) {
      draggedId = id;
      e.target.classList.add('dragging');
    }
    
    function dragEnd(e) {
      e.target.classList.remove('dragging');
    }
    
    function dropItem(e, stage) {
      e.preventDefault();
      if (draggedId) {
        const item = items.find(i => i.id === draggedId);
        if (item) {
          item.stage = stage;
          saveItems();
          renderBoard();
          renderManifests();
          renderFleet();
        }
      }
      draggedId = null;
    }
    
    // Update stats
    function updateStats() {
      document.getElementById('statStaged').textContent = items.filter(i => i.stage === 'Staged').length;
      document.getElementById('statPacked').textContent = items.filter(i => i.stage === 'Packed' || i.stage === 'Loaded').length;
      document.getElementById('statTransit').textContent = items.filter(i => i.stage === 'In Transit').length;
      document.getElementById('statDelivered').textContent = items.filter(i => i.stage === 'Delivered').length;
    }
    
    // Render fleet
    function renderFleet() {
      const grid = document.getElementById('fleetGrid');
      grid.innerHTML = fleet.map(truck => {
        const truckItems = items.filter(i => i.truck === truck.id);
        return `
          <div class="fleet-card">
            <div class="fleet-header">
              <span class="fleet-name">üöõ ${truck.id}</span>
              <span class="fleet-status status-${truck.status}">${truck.status.toUpperCase()}</span>
            </div>
            <div class="fleet-body">
              <div class="fleet-location">üìç ${truck.location}</div>
              <div class="fleet-items">üì¶ ${truckItems.length} items assigned</div>
              ${truck.driver ? `<div class="fleet-driver">üë§ ${truck.driver}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Render loading zones
    function renderZones() {
      const bays = document.getElementById('bayDoors');
      bays.innerHTML = loadingZones.bayDoors.map(zone => `
        <div class="zone-card ${zone.status}">
          ${zone.status === 'loading' ? '<span class="zone-badge badge-loading">LOADING</span>' : ''}
          <div class="zone-name">${zone.name}</div>
          ${zone.truck ? `<div class="zone-truck">üöõ ${zone.truck}</div>` : '<div class="zone-status">Available</div>'}
        </div>
      `).join('');
      
      const yard = document.getElementById('yardPositions');
      yard.innerHTML = loadingZones.yard.map(zone => `
        <div class="zone-card ${zone.status}">
          <div class="zone-name">${zone.name}</div>
          ${zone.truck ? `<div class="zone-truck">üöõ ${zone.truck}</div>` : '<div class="zone-status">Empty</div>'}
        </div>
      `).join('');
    }
    
    // Render venues
    function renderVenues() {
      const grid = document.getElementById('venuesGrid');
      grid.innerHTML = venues.map(venue => {
        const venueItems = items.filter(i => i.venue === venue.id);
        const delivered = venueItems.filter(i => i.stage === 'Delivered').length;
        const inTransit = venueItems.filter(i => i.stage === 'In Transit').length;
        const pending = venueItems.filter(i => ['Staged', 'Packed', 'Loaded'].includes(i.stage)).length;
        
        return `
          <div class="venue-card">
            <div class="venue-name">üìç ${venue.name}</div>
            <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 8px;">${venue.region}</div>
            <div class="venue-stats">
              <div class="venue-stat">Delivered: <strong style="color: var(--green);">${delivered}</strong></div>
              <div class="venue-stat">Transit: <strong style="color: var(--blue);">${inTransit}</strong></div>
              <div class="venue-stat">Pending: <strong style="color: var(--orange);">${pending}</strong></div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Render manifests - show what's on each truck
    function renderManifests() {
      const grid = document.getElementById('manifestsGrid');
      grid.innerHTML = fleet.map(truck => {
        const truckItems = items.filter(i => i.truck === truck.id);
        
        return `
          <div class="manifest-card" id="manifest-${truck.id}">
            <div class="manifest-header" onclick="toggleManifest('${truck.id}')">
              <div class="manifest-truck-info">
                <span class="manifest-truck-icon">${truck.type === 'Flatbed' ? 'üõª' : truck.type === 'Conex' ? 'üì¶' : 'üöõ'}</span>
                <div>
                  <div class="manifest-truck-name">${truck.id}</div>
                  <div class="manifest-truck-meta">${truck.type} ‚Ä¢ ${truck.status === 'transit' ? 'üöó ' + truck.location : 'üìç ' + truck.location}</div>
                </div>
              </div>
              <div class="manifest-summary">
                <div class="manifest-count">${truckItems.length}</div>
                <div class="manifest-count-label">items</div>
              </div>
              <span class="manifest-toggle">‚ñº</span>
            </div>
            <div class="manifest-body" id="manifest-body-${truck.id}">
              ${truckItems.length > 0 ? `
                <div class="manifest-items">
                  ${truckItems.map(item => `
                    <div class="manifest-item">
                      <div>
                        <div class="manifest-item-name">${item.name}</div>
                        <div class="manifest-item-desc">${item.desc || 'No description'}${item.venue ? `<span class="manifest-item-venue">‚Üí ${venues.find(v => v.id === item.venue)?.name || item.venue}</span>` : ''}</div>
                      </div>
                      <div class="manifest-item-qty">√ó${item.qty}</div>
                    </div>
                  `).join('')}
                </div>
              ` : `
                <div class="manifest-empty">No items assigned to this truck</div>
              `}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function toggleManifest(truckId) {
      const card = document.getElementById('manifest-' + truckId);
      const body = document.getElementById('manifest-body-' + truckId);
      card.classList.toggle('open');
      body.classList.toggle('open');
    }
    
    // Add item
    function addItem() {
      const name = document.getElementById('itemName').value.trim();
      if (!name) {
        alert('Please enter an item name');
        return;
      }
      
      const newItem = {
        id: Date.now(),
        name,
        qty: parseInt(document.getElementById('itemQty').value) || 1,
        desc: document.getElementById('itemDesc').value.trim(),
        barcode: document.getElementById('itemBarcode').value.trim(),
        venue: document.getElementById('itemVenue').value,
        laneCode: document.getElementById('itemLaneCode').value.trim().toUpperCase(),
        truck: document.getElementById('itemTruck').value,
        stage: 'Staged'
      };
      
      items.push(newItem);
      saveItems();
      renderBoard();
      renderManifests();
      renderFleet();
      
      // Clear form
      document.getElementById('itemName').value = '';
      document.getElementById('itemDesc').value = '';
      document.getElementById('itemBarcode').value = '';
      document.getElementById('itemLaneCode').value = '';
      
      // Switch to board tab
      document.querySelector('[data-tab="board"]').click();
    }
    
    // Save items ‚Äî Supabase first, localStorage cache
    function saveItems() {
      localStorage.setItem('truckingItems', JSON.stringify(items));
      localStorage.setItem('truckingFleet', JSON.stringify(fleet));
      // Cloud-first save to proper tables
      TruckingDB.saveAllItems(items).then(r => {
        if (r.synced) console.log('‚úÖ Items synced to Supabase (trucking_items table)');
      });
      TruckingDB.saveAllFleet(fleet).then(r => {
        if (r.synced) console.log('‚úÖ Fleet synced to Supabase (trucking_loads table)');
      });
    }
    
    // Export CSV
    function exportCSV() {
      let csv = 'Name,Quantity,Description,Stage,Truck,Venue,Barcode\n';
      items.forEach(item => {
        csv += `"${item.name}","${item.qty}","${item.desc || ''}","${item.stage}","${item.truck || ''}","${item.venue || ''}","${item.barcode || ''}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `trucking-tracker-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }
    
    // Sync data ‚Äî force push/pull with Supabase
    async function syncData() {
      if (!TruckingDB.online) { alert('‚ö†Ô∏è Offline ‚Äî cannot sync'); return; }
      try {
        await TruckingDB.saveAllItems(items);
        await TruckingDB.saveAllFleet(fleet);
        alert('‚úÖ Synced to Supabase!\n\n' + items.length + ' items ‚Üí trucking_items\n' + fleet.length + ' trucks ‚Üí trucking_loads');
      } catch(e) { alert('‚ùå Sync failed: ' + e.message); }
    }
    
    // Scanner functionality
    let html5QrScanner = null;
    let currentScannedItem = null;
    let rfidScannedItem = null;
    let manualScannedItem = null;
    
    function openScanner() {
      document.getElementById('scannerModal').classList.add('open');
      switchScannerTab('qr');
    }
    
    function closeScanner() {
      document.getElementById('scannerModal').classList.remove('open');
      stopCamera();
    }
    
    function switchScannerTab(tab) {
      document.querySelectorAll('.scanner-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.scanner-body').forEach(b => b.style.display = 'none');
      
      const clickedTab = document.querySelector(`.scanner-tab[onclick*="${tab}"]`) || event?.target;
      if (clickedTab) clickedTab.classList.add('active');
      document.getElementById('scanner-' + tab).style.display = 'flex';
      
      if (tab === 'qr') {
        startCamera();
      } else {
        stopCamera();
        if (tab === 'rfid') {
          document.getElementById('rfidInput').focus();
        } else if (tab === 'manual') {
          document.getElementById('manualInput').focus();
        }
      }
    }
    
    async function startCamera() {
      try {
        // Stop any existing scanner
        await stopCamera();
        
        // Replace video element with scanner div
        const container = document.getElementById('scanner-qr');
        let scannerDiv = document.getElementById('qr-reader');
        if (!scannerDiv) {
          // Hide the old video element, create scanner div
          const video = document.getElementById('scannerVideo');
          if (video) video.style.display = 'none';
          
          scannerDiv = document.createElement('div');
          scannerDiv.id = 'qr-reader';
          scannerDiv.style.width = '100%';
          scannerDiv.style.maxWidth = '400px';
          container.insertBefore(scannerDiv, container.firstChild);
        }
        
        html5QrScanner = new Html5Qrcode('qr-reader');
        
        await html5QrScanner.start(
          { facingMode: 'environment' },
          {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
          },
          onScanSuccess,
          onScanFailure
        );
        
      } catch (err) {
        console.error('Camera error:', err);
        alert('Could not access camera. Please allow camera permissions or use Manual Entry tab.');
      }
    }
    
    async function stopCamera() {
      if (html5QrScanner) {
        try {
          await html5QrScanner.stop();
        } catch (e) {
          // Already stopped
        }
        html5QrScanner = null;
      }
    }
    
    function onScanSuccess(decodedText, decodedResult) {
      console.log('Scanned:', decodedText);
      
      // Look up item by barcode
      const item = items.find(i => i.barcode?.toLowerCase() === decodedText.toLowerCase());
      
      if (item) {
        currentScannedItem = item;
        playBeep();
        
        // Show scan result
        document.getElementById('qrScanResult').style.display = 'block';
        document.getElementById('qrItemName').textContent = item.name + (item.qty > 1 ? ` (√ó${item.qty})` : '');
        document.getElementById('qrItemMeta').textContent = `Stage: ${item.stage} | Truck: ${item.truck || 'None'}`;
        document.getElementById('qrActionStage').value = item.stage;
        document.getElementById('qrActionTruck').value = item.truck || '';
        document.getElementById('qrActions').style.display = 'flex';
        
        // Pause scanner
        stopCamera();
      } else {
        // Item not found - show barcode anyway
        playBeep();
        document.getElementById('qrScanResult').style.display = 'block';
        document.getElementById('qrItemName').textContent = '‚ùì Unknown Item';
        document.getElementById('qrItemMeta').textContent = `Barcode: ${decodedText}`;
        document.getElementById('qrActions').style.display = 'none';
        currentScannedItem = null;
      }
    }
    
    function onScanFailure(error) {
      // Ignore - this fires constantly when no QR is found
    }
    
    function applyQrAction() {
      if (!currentScannedItem) {
        alert('No item selected');
        return;
      }
      
      const stage = document.getElementById('qrActionStage').value;
      const truck = document.getElementById('qrActionTruck').value;
      
      if (stage) currentScannedItem.stage = stage;
      currentScannedItem.truck = truck;
      
      saveItems();
      renderBoard();
      renderManifests();
      renderFleet();
      
      playBeep();
      alert(`‚úÖ Updated: ${currentScannedItem.name}`);
      
      // Reset and resume scanning
      document.getElementById('qrScanResult').style.display = 'none';
      currentScannedItem = null;
      startCamera();
    }
    
    function scanAnother() {
      document.getElementById('qrScanResult').style.display = 'none';
      currentScannedItem = null;
      startCamera();
    }
    
    // Note: Real QR scanning now handled by html5-qrcode library via onScanSuccess()
    
    function playBeep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = ctx.createOscillator();
      const gain = ctx.createGain();
      oscillator.connect(gain);
      gain.connect(ctx.destination);
      oscillator.frequency.value = 1200;
      gain.gain.value = 0.3;
      oscillator.start();
      setTimeout(() => oscillator.stop(), 100);
    }
    
    function applyScanAction() {
      if (!currentScannedItem) {
        alert('No item selected');
        return;
      }
      
      const stage = document.getElementById('scanActionStage').value;
      const truck = document.getElementById('scanActionTruck').value;
      
      if (stage) currentScannedItem.stage = stage;
      currentScannedItem.truck = truck;
      
      saveItems();
      renderBoard();
      renderManifests();
      renderFleet();
      
      playBeep();
      alert(`‚úÖ Updated: ${currentScannedItem.name}\nStage: ${currentScannedItem.stage}\nTruck: ${currentScannedItem.truck || 'None'}`);
    }
    
    function continueScan() {
      document.getElementById('scanResult').classList.remove('show');
      currentScannedItem = null;
    }
    
    // RFID functionality
    document.addEventListener('DOMContentLoaded', () => {
      const rfidInput = document.getElementById('rfidInput');
      if (rfidInput) {
        let rfidBuffer = '';
        let rfidTimeout;
        
        rfidInput.addEventListener('input', (e) => {
          clearTimeout(rfidTimeout);
          rfidBuffer = e.target.value;
          
          // RFID readers typically send data quickly then stop
          rfidTimeout = setTimeout(() => {
            if (rfidBuffer.length > 3) {
              handleRfidScan(rfidBuffer);
            }
          }, 300);
        });
        
        rfidInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && rfidInput.value.trim()) {
            handleRfidScan(rfidInput.value.trim());
          }
        });
      }
    });
    
    function handleRfidScan(tag) {
      document.getElementById('rfidResult').classList.add('show');
      document.getElementById('rfidCode').textContent = tag;
      
      // Look up item by barcode (RFID tags would map to barcodes)
      const item = items.find(i => i.barcode === tag);
      if (item) {
        rfidScannedItem = item;
        document.getElementById('rfidItem').style.display = 'block';
        document.getElementById('rfidItemName').textContent = item.name + (item.qty > 1 ? ` (√ó${item.qty})` : '');
        document.getElementById('rfidItemMeta').textContent = `Stage: ${item.stage} | Truck: ${item.truck || 'None'}`;
        document.getElementById('rfidActionStage').value = item.stage;
        document.getElementById('rfidActionTruck').value = item.truck || '';
      } else {
        rfidScannedItem = null;
        document.getElementById('rfidItem').style.display = 'none';
      }
      
      playBeep();
      document.getElementById('rfidInput').value = '';
      document.getElementById('rfidInput').focus();
    }
    
    function applyRfidAction() {
      if (!rfidScannedItem) {
        alert('No item selected');
        return;
      }
      
      const stage = document.getElementById('rfidActionStage').value;
      const truck = document.getElementById('rfidActionTruck').value;
      
      if (stage) rfidScannedItem.stage = stage;
      rfidScannedItem.truck = truck;
      
      saveItems();
      renderBoard();
      renderManifests();
      renderFleet();
      
      playBeep();
      alert(`‚úÖ Updated: ${rfidScannedItem.name}`);
      
      document.getElementById('rfidResult').classList.remove('show');
      document.getElementById('rfidItem').style.display = 'none';
      rfidScannedItem = null;
    }
    
    // Manual lookup
    function lookupManual() {
      const code = document.getElementById('manualInput').value.trim();
      if (!code) {
        alert('Please enter a barcode or item name');
        return;
      }
      
      // Look up by barcode or name
      const item = items.find(i => 
        i.barcode?.toLowerCase() === code.toLowerCase() || 
        i.name.toLowerCase().includes(code.toLowerCase())
      );
      
      if (item) {
        manualScannedItem = item;
        document.getElementById('manualItem').style.display = 'block';
        document.getElementById('manualItemName').textContent = item.name + (item.qty > 1 ? ` (√ó${item.qty})` : '');
        document.getElementById('manualItemMeta').textContent = `Stage: ${item.stage} | Truck: ${item.truck || 'None'} | Barcode: ${item.barcode || 'None'}`;
        document.getElementById('manualActions').style.display = 'flex';
        document.getElementById('manualActionStage').value = item.stage;
        document.getElementById('manualActionTruck').value = item.truck || '';
        playBeep();
      } else {
        manualScannedItem = null;
        document.getElementById('manualItem').style.display = 'none';
        document.getElementById('manualActions').style.display = 'none';
        alert('Item not found. Try a different barcode or name.');
      }
    }
    
    function applyManualAction() {
      if (!manualScannedItem) {
        alert('No item selected');
        return;
      }
      
      const stage = document.getElementById('manualActionStage').value;
      const truck = document.getElementById('manualActionTruck').value;
      
      if (stage) manualScannedItem.stage = stage;
      manualScannedItem.truck = truck;
      
      saveItems();
      renderBoard();
      renderManifests();
      renderFleet();
      
      playBeep();
      alert(`‚úÖ Updated: ${manualScannedItem.name}`);
      
      document.getElementById('manualInput').value = '';
      document.getElementById('manualItem').style.display = 'none';
      document.getElementById('manualActions').style.display = 'none';
      manualScannedItem = null;
    }
    
    // Initialize with local data first
    renderBoard();
    renderFleet();
    renderZones();
    renderVenues();
    renderManifests();
    
    // Cloud-first load from Supabase proper tables
    (async function loadCloudData() {
      const cloudItems = await TruckingDB.loadItems();
      const cloudFleet = await TruckingDB.loadFleet();
      if (cloudItems && cloudItems.length > 0) {
        items = cloudItems;
        localStorage.setItem('truckingItems', JSON.stringify(items));
        console.log('‚úÖ Loaded', items.length, 'items from Supabase (trucking_items)');
        renderBoard();
        renderManifests();
        renderVenues();
      } else if (items.length > 0 && TruckingDB.online) {
        // Push local data to cloud on first use
        console.log('‚òÅÔ∏è Pushing local items to Supabase...');
        await TruckingDB.saveAllItems(items);
      }
      if (cloudFleet && cloudFleet.length > 0) {
        fleet = cloudFleet;
        localStorage.setItem('truckingFleet', JSON.stringify(fleet));
        console.log('‚úÖ Loaded', fleet.length, 'trucks from Supabase (trucking_loads)');
        renderFleet();
        renderManifests();
      } else if (fleet.length > 0 && TruckingDB.online) {
        console.log('‚òÅÔ∏è Pushing local fleet to Supabase...');
        await TruckingDB.saveAllFleet(fleet);
      }
    })();
    
    // Splash
    setTimeout(() => document.getElementById('splash').classList.add('hidden'), 2000);
  </script>
</body>
</html>
